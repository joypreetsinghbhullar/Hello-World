<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GPA Calculator</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Space Grotesk', sans-serif;
      background-color: #202A44;
      color: white;
      margin: 0;
      padding: 2rem;
    }

    .glass {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 1rem;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
    }

    .input-group {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    input {
      padding: 0.4rem;
      border: none;
      border-radius: 0.5rem;
      width: 100%;
    }

    button {
      padding: 0.6rem 1rem;
      background-color: #FFCD00;
      color: #202A44;
      border: none;
      border-radius: 0.5rem;
      cursor: pointer;
      font-weight: bold;
    }

    .center {
      text-align: center;
    }

    canvas {
      background: #ffffff0a;
      border-radius: 1rem;
      padding: 1rem;
    }

    .key-table {
      margin: 1rem auto;
      border-collapse: collapse;
      background: rgba(255,255,255,0.08);
      border-radius: 1rem;
      overflow: hidden;
    }

    .key-table th, .key-table td {
      padding: 0.5rem 1rem;
      border: 1px solid rgba(255,255,255,0.1);
      text-align: center;
    }

    .highlight {
      background-color: #FFCD00;
      color: #202A44;
      font-weight: bold;
    }

    .tiny {
      font-size: 0.9rem;
      color: #ccc;
    }
  </style>
</head>
<body>

<h1 class="center">GPA Calculator ðŸ§®</h1>
<p class="center tiny">Estimation only â€” GPA rounding follows fixed steps.</p>

<button onclick="addSubject()">+ Add Subject</button>
<div id="subjectsContainer"></div>

<h2 class="center">Your GPA (Rounded): <span id="overallGPA">0.00</span> / 15</h2>
<h3 class="center tiny">Raw GPA: <span id="rawGPA">0.00</span></h3>
<p class="center" id="motivational"></p>

<canvas id="gpaChart" width="400" height="200"></canvas>

<h3 class="center">GPA Decimal Rounding Key</h3>
<table class="key-table" id="gpaKeyTable">
  <tr id="keyRow"></tr>
</table>

<script>
  const subjects = [];
  const allowedDecimals = [0.00, 0.14, 0.29, 0.43, 0.57, 0.71, 0.84];

  function roundToGPAConstant(value) {
    const intPart = Math.floor(value);
    const decimal = value - intPart;

    let closest = allowedDecimals[0];
    let minDiff = Math.abs(decimal - closest);

    for (let i = 1; i < allowedDecimals.length; i++) {
      const diff = Math.abs(decimal - allowedDecimals[i]);
      if (diff < minDiff) {
        minDiff = diff;
        closest = allowedDecimals[i];
      }
    }

    return parseFloat((intPart + closest).toFixed(2));
  }

  function percentageToGPA(percent) {
    const scale = [
      { min: 95, gpa: 15 },
      { min: 90, gpa: 14 },
      { min: 85, gpa: 13 },
      { min: 80, gpa: 12 },
      { min: 75, gpa: 11 },
      { min: 70, gpa: 10 },
      { min: 65, gpa: 9 },
      { min: 60, gpa: 8 },
      { min: 55, gpa: 7 },
      { min: 50, gpa: 6 },
      { min: 45, gpa: 5 },
      { min: 40, gpa: 4 },
      { min: 35, gpa: 3 },
      { min: 30, gpa: 2 },
      { min: 25, gpa: 1 },
      { min: 0, gpa: 0 },
    ];
    for (const entry of scale) {
      if (percent >= entry.min) return entry.gpa;
    }
    return 0;
  }

  function addSubject() {
    const index = subjects.length;
    subjects.push({ name: '', assessments: [] });

    const container = document.getElementById('subjectsContainer');
    const card = document.createElement('div');
    card.className = 'glass';
    card.innerHTML = `
      <input placeholder="Subject name" onchange="subjects[${index}].name = this.value" />
      <div id="assessments-${index}"></div>
      <button onclick="addAssessment(${index})">+ Add Assessment</button>
    `;
    container.appendChild(card);
  }

  function addAssessment(subjectIndex) {
    subjects[subjectIndex].assessments.push({ score: 0, outOf: 100, weight: 1 });
    renderAssessments(subjectIndex);
  }

  function renderAssessments(subjectIndex) {
    const container = document.getElementById(`assessments-${subjectIndex}`);
    container.innerHTML = '';
    subjects[subjectIndex].assessments.forEach((a, aIdx) => {
      container.innerHTML += `
        <div class="input-group">
          <input type="number" placeholder="Score" oninput="subjects[${subjectIndex}].assessments[${aIdx}].score = parseFloat(this.value)" />
          <input type="number" placeholder="Out Of" oninput="subjects[${subjectIndex}].assessments[${aIdx}].outOf = parseFloat(this.value)" />
          <input type="number" placeholder="Weight" value="1" oninput="subjects[${subjectIndex}].assessments[${aIdx}].weight = parseFloat(this.value)" />
        </div>
      `;
    });
    updateGPA();
  }

  function updateGPA() {
    const subjectGPAs = [];
    let totalGPA = 0;

    subjects.forEach(sub => {
      let weightedTotal = 0;
      let weightSum = 0;

      sub.assessments.forEach(a => {
        const percent = (a.score / a.outOf) * 100;
        const gpa = percentageToGPA(percent);
        weightedTotal += gpa * a.weight;
        weightSum += a.weight;
      });

      const subjectGPA = weightSum ? weightedTotal / weightSum : 0;
      const roundedSubjectGPA = roundToGPAConstant(subjectGPA);
      subjectGPAs.push(roundedSubjectGPA);
      totalGPA += roundedSubjectGPA;
    });

    const raw = subjects.length ? totalGPA / subjects.length : 0;
    const rounded = roundToGPAConstant(raw);

    document.getElementById('overallGPA').textContent = rounded.toFixed(2);
    document.getElementById('rawGPA').textContent = raw.toFixed(2);

    document.getElementById('motivational').textContent = rounded < 13 ? "You're more than a number ðŸ’™" : '';

    const chart = Chart.getChart("gpaChart");
    if (chart) chart.destroy();

    new Chart(document.getElementById("gpaChart"), {
      type: "bar",
      data: {
        labels: subjects.map(s => s.name || "Unnamed"),
        datasets: [{
          label: "Subject GPA",
          data: subjectGPAs,
          backgroundColor: "#FFCD00"
        }]
      }
    });

    drawKeyRow(raw);
  }

  function drawKeyRow(rawValue) {
    const decimal = parseFloat((rawValue % 1).toFixed(2));
    const row = document.getElementById("keyRow");
    row.innerHTML = '';
    allowedDecimals.forEach(d => {
      const td = document.createElement("td");
      td.textContent = d.toFixed(2);
      if (Math.abs(d - decimal) < 0.07) {
        td.className = "highlight";
      }
      row.appendChild(td);
    });
  }

  setInterval(updateGPA, 1000);
</script>

</body>
</html>
